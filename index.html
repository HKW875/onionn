<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>onionn</title>

  <!-- Leaflet (Free Map Provider: OpenStreetMap tiles) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    #trackOrderButton {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background: white;
      color: black;
      border-radius: 8px;
    }

    #trackOrderMap {
      height: 340px;
      border-radius:12px;
      width: 100%;
      margin-top: 20px;
      border:1px solid var(--border);
      display: none; /* hidden until button is clicked */
    }
    :root{
      --brand:#1f2937; /* dark blue/black */
      --brand-dark:#0f7c36;
      --ink:#1f2937;
      --muted:#6b7280;
      --bg:#f7faf7;
      --card:#ffffff;
      --border:#1f2937;
      --accent:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background:var(--bg);
    }
    header{
      padding:24px 12px 8px;
      text-align:center;
    }
    .logo{
      display:inline-flex;
      align-items:center;
      gap:12px;
      margin:auto;
      font-weight:800;
      font-size: clamp(24px, 3.5vw, 40px);
      color:var(--brand);
      letter-spacing:0.5px;
    }
    .logo .mark{
      width:42px;height:42px;border-radius:10px;
      background:linear-gradient(135deg, var(--brand), #7ddf8f);
      display:inline-flex;align-items:center;justify-content:center;
      color:white;font-weight:900;
      box-shadow:0 6px 20px rgba(23,163,74,0.25);
    }
    .container{
      max-width:980px;margin:0 auto;padding:0 12px 60px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 24px rgba(0,0,0,0.04);
      margin-top:12px;
    }
    #map{
      width:100%;
      height:340px;
      border-radius:12px;
      border:1px solid var(--border);
    }
    .two-col{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
    }
    @media (min-width:900px){
      .two-col{grid-template-columns: 1fr 1fr;}
    }
    h2{
      margin:10px 0 6px;font-size:15px;text-align: center;
    }
    label{display:block;font-size:14px;color:var(--muted);margin:12px 0 6px}
    input, select, button, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:16px;
      outline:none;
      background:white;
    }
    input:focus, textarea:focus, select:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 4px rgba(23,163,74,0.12);
    }
    .row{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
    }
    .btn{
      cursor:pointer;
      background:var(--brand);color:white;border:none;
      font-weight:700;
      transition:.2s; margin-top:12px;
    }
    .btn.secondary{
      background:#111827;color:#fff;
    }
    .btn.ghost{
      background:transparent;color:var(--brand);border:1px solid var(--brand);margin-bottom: 10px;
    }
    .btn:hover{filter:brightness(0.95)}
    .muted{color:var(--muted)}
    .success{color:var(--brand-dark);font-weight:600}
    .tabs{
      display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;
      border-bottom:1px solid var(--border);padding-bottom:6px;
    }
    .tab{
      padding:10px 14px;border-radius:10px;border:1px solid var(--border);
      background:var(--card);cursor:pointer;font-weight:600;
    }
    .tab.active{
      background:var(--brand);color:white;border-color:var(--brand);
    }
    .hidden{display:none !important}
    .right{justify-self:end}
    .tag{
      display:inline-block;background:#ecfdf5;color:var(--brand-dark);
      border:1px solid #bbf7d0;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700
    }
    .list{display:grid;gap:10px;margin-top:12px}
    .order-item{
      border:1px solid var(--border);border-radius:10px;padding:10px;background:white;
      display:grid;gap:6px
    }
    .pill{
      display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;font-size:12px
    }
    .right-actions{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end
    }
    .helper{font-size:12px;color:var(--muted)}
    .center{text-align:center}
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.3);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .modal{
      width:min(560px, 100%);background:white;border-radius:12px;border:1px solid var(--border);padding:16px;
    }
    .footnote{margin-top:14px;font-size:12px;color:var(--muted)}
    .seller-box{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:8px
    }
    .seller-pill{
      border:1px solid var(--border);border-radius:8px;padding:6px 10px;background:#fff
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <span class="mark">🧅</span> Onionn
    </div>
  </header>

  <div class="container">
    <!-- MAP + SELLER LOCATIONS (always visible on auth screen) -->
    <div class="card">
      <h2>See nearby Onionn Sellers. Lowest price guarantee when you order online. Free same day delivery.</h2>
      <h2>Service currently only available in Nairobi and Kilifi.</h2>
      <h2>📱Order online 🚚 Track delivery 💵 Earn points</h2>
      <div id="map"></div>
      <div class="helper">Tip: Pinch or scroll to zoom. If you allow location, the map will focus near you and show sellers nearby.</div>
      <div id="sellerChips" class="seller-box"></div>
    </div>

    <!-- AUTH CARD -->
    <div id="authCard" class="card">
      <div class="two-col">
        <!-- Create Account -->
        <div>
          <h2>Create Account</h2>
          <label>Name</label>
          <input id="regName" type="name" placeholder="your name" />
          <label>Email</label>
          <input id="regEmail" type="email" placeholder="you@example.com" />
          <label>Phone</label>
          <input id="regPhone" type="tel" placeholder="07XXXXXXXX" />
          <label>Password</label>
          <input id="regPass" type="password" placeholder="••••••••" />
          <button id="btnCreate" class="btn">Create account</button>

          <!-- Verification step -->
          <div id="verifyBox" class="hidden">
            <label>Enter verification code (sent to your phone)</label>
            <input id="verifyCode" type="text" inputmode="numeric" placeholder="6-digit code" />
            <button id="btnVerify" class="btn">Verify & Continue</button>
            <div class="helper">Demo: We simulate SMS. In production, this will be an actual SMS code.</div>
          </div>
        </div>

        <!-- Login -->
        <div>
          <h2>Login</h2>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="you@example.com" />
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="••••••••" />
          <button id="btnLogin" class="btn secondary">Log in</button>
        </div>
      </div>
    </div>

    <!-- APP (visible after login) -->
    <div id="appCard" class="card hidden">
      <div class="row" style="align-items:center">
        <div><h2>Welcome, <span id="welcomeName"></span> <span class="tag">KSh 60 / kg</span></h2></div>
        <div class="right-actions">
          <button id="btnLogout" class="btn ghost">Log out</button>
        </div>
      </div>

      <div class="tabs">
        <button data-tab="new" class="tab active">New Order</button>
        <button data-tab="contact" class="tab">Track Delivery</button>     
        <button data-tab="history" class="tab">History</button>
        <button data-tab="contact" class="tab">Contact</button>

      </div>

      
      <!-- NEW ORDER -->
      <section id="tab-new">
        <div class="two-col">
          <div>
            <label>Choose seller</label>
            <select id="sellerSelect"></select>
              
            
            <div class="row">
              <div>
                <label>Quantity (kg)</label>
                <input id="qty" type="number" min="1" step="1" value="10" />
              </div>
              <div>
                <label>Total (KSh @ 60/kg)</label>
                <input id="total" type="text" value="600" readonly />
              </div>
            </div>

            <label>Delivery notes (optional)</label>
            <textarea id="notes" rows="3" placeholder="Estate name, landmarks, delivery time…"></textarea>
            
            <label>Choose option, and click to submit order</label>
            <div class="row">
              <button id="btnPayNow" class="btn">Pay Now (M-Pesa)</button>
              <button id="btnPayOnDelivery" class="btn secondary">Pay on Delivery</button>
            </div>
            <div class="footnote">After you choose a payment option, your order is sent to the seller and you can track delivery.</div>
          </div>
          
          <div>
            <div class="card">
              <strong>Order summary</strong>
              <div class="list">               
                <div><span class="muted">Name:</span> <span id="name"> </span></div>
                <div><span class="muted">Quantity:</span> <span id="orderQuantity">—</span></div>
                <div><span class="muted">Unit price:</span> KSh <strong>60</strong> / kg</div>
                <div><span class="muted">Selected seller:</span> <span id="summarySeller">Closest</span></div>
                <div><span class="muted">Your phone:</span> <span id="summaryPhone"> </span></div>
                <div><span class="muted">Location:</span> <span id="fromGeoLocation">—</span></div>
                <div><span class="muted">Order time:</span> <span id="orderTime">—</span></div>
                <div><span class="muted">Status:</span> <span id="summaryStatus" class="pill">Draft</span></div>
              </div>
            </div>
            <div class="helper">Need to change your number? Log out and update your account after we add profile editing.</div>
          </div>
        </div>
      </section>

      <!-- TRACK DELIVERY -->
      <section id="tab-contact" class="hidden">
        <div class="card">
          <p><strong>Track Delivery</strong></p>
          <p class="muted">Email: support@onionn.africa<br/>Phone/Whatsapp +254000000000</p>
          <p class="helper">For delivery issues, contact your selected seller directly. Their phone is shown in your order.</p>
        </div>
      </section>
      
      <!-- TRACK ORDER -->
      <section id="tab-track" class="hidden">
      </section>

      <!-- HISTORY -->
      <section id="tab-history" class="hidden">
        <div class="list" id="historyList"></div>
        <div class="helper">Orders are stored locally for demo. Hook to your backend to persist.</div>
      </section>

      <!-- CONTACT -->
      <section id="tab-contact" class="hidden">
        <div class="card">
          <p><strong>Onionn Support</strong></p>
          <p class="muted">Email: support@onionn.africa<br/>Phone/Whatsapp +254000000000</p>
          <p class="helper">For payments and delivery issues, contact your selected seller directly. Their phone is shown in your order.</p>
        </div>
      </section>
    </div>
  </div>

  <!-- PAYMENT MODAL -->
  <div id="paymentModal" class="modal-backdrop">
    <div class="modal">
      <h3>Pay Now via M-Pesa STK</h3>
      <label>Phone to charge</label>
      <input id="stkPhone" type="tel" />
      <label>Amount (KSh)</label>
      <input id="stkAmount" type="text" readonly />
      <div class="row">
        <button id="btnStartStk" class="btn">Request STK</button>
        <button id="btnCancelStk" class="btn ghost">Cancel</button>
      </div>
      <div id="stkStatus" class="helper" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    /***********************
     * Simple local "store"
     ***********************/
    const PRICE_PER_KG = 60;
    const store = {
      get users(){ return JSON.parse(localStorage.getItem('onion_users')||'[]') },
      set users(v){ localStorage.setItem('onion_users', JSON.stringify(v)) },
      get session(){ return JSON.parse(localStorage.getItem('onion_session')||'null') },
      set session(v){ localStorage.setItem('onion_session', JSON.stringify(v)) },
      get orders(){ return JSON.parse(localStorage.getItem('onion_orders')||'[]') },
      set orders(v){ localStorage.setItem('onion_orders', JSON.stringify(v)) },
      setVerify(phone, code){ localStorage.setItem('verify_'+phone, code) },
      getVerify(phone){ return localStorage.getItem('verify_'+phone) },
      clearVerify(phone){ localStorage.removeItem('verify_'+phone) },
    };
    
    /***********************
     * Filling out order summary"
     ***********************/
      // Show user info if logged in
    function displayUserInfo() {
      const isLoggedIn = localStorage.getItem("isLoggedIn");

      if (isLoggedIn === "true") {
        const name = localStorage.getItem("name");
        const phone = localStorage.getItem("phone");

        document.getElementById("name").textContent = name || "";
        document.getElementById("phone").textContent = phone || "";
      } else {
        document.getElementById("name").textContent = "";
        document.getElementById("phone").textContent = "";
      }
    }


    // Run on page load
    document.addEventListener("DOMContentLoaded", displayUserInfo);


    // Get the saved user from localStorage
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    

    // Check if user exists before filling
    if (currentUser) {
      // Fill the Name field
      const nameEl = document.getElementById("name");
      if (nameEl && currentUser.regName) {
        nameEl.textContent = currentUser.regName;
      }

      // Fill the Phone field
      const phoneEl = document.getElementById("summaryPhone");
      if (phoneEl && currentUser.phone) {
        phoneEl.textContent = currentUser.phone;
      }
    }

    
    
    document.addEventListener("DOMContentLoaded", () => {
      // Retrieve values from localStorage
      const storedName  = JSON.parse(localStorage.getItem("currentUser.name")); 
      const storedPhone = JSON.parse(localStorage.getItem("currentUser.phone"));

      // Target spans
      const nameSpan    = document.getElementById("name");
      const phoneSpan   = document.getElementById("summaryPhone");
      const timeSpan    = document.getElementById("orderTime");
      const statusSpan  = document.getElementById("summaryStatus");
      const locationSpan = document.getElementById("fromGeoLocation");

      // Fill in name
      nameSpan.textContent = storedName;

      // Fill in phone
      phoneSpan.textContent = storedPhone;

      // Function to update order time live
      function updateTime() {
        const now = new Date();
        const formattedTime = now.toLocaleString("en-KE", {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false
        });
        timeSpan.textContent = formattedTime;
      }

      // Update immediately + every second
      updateTime();
      setInterval(updateTime, 1000);

      // --- Status Updates ---
      statusSpan.textContent = "Draft";
      statusSpan.className = "pill draft";

      setTimeout(() => {
        statusSpan.textContent = "Pending";
        statusSpan.className = "pill pending";
      }, 5000);

      setTimeout(() => {
        statusSpan.textContent = "Confirmed";
        statusSpan.className = "pill confirmed";
      }, 10000);

      // --- Geo Location ---
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            locationSpan.textContent = `Lat: ${latitude.toFixed(5)}, Lng: ${longitude.toFixed(5)}`;
          },
          (error) => {
            locationSpan.textContent = "Location not available";
          }
        );
      } else {
        locationSpan.textContent = "Geolocation not supported";
      }
    });

    
    /***********************
     * Demo seller data
     ***********************/
    const sellers = [
      { id:'S1', name:'Onionn', phone:'Order online', lat:-1.5945032, lng:36.9272013 },
      { id:'S2', name:'OnionsHub', phone:'Order online', lat:-3.603548, lng:39.857002 },
    ];

    /***********************
     * Map
     ***********************/
    let map, userMarker;
    function initMap(){
      map = L.map('map').setView([ -1.286389, 36.817223 ], 8); // Kenya default (Nairobi-ish)

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
      }).addTo(map);

      // Seller markers
      sellers.forEach(s=>{
        const m = L.marker([s.lat, s.lng]).addTo(map);
        m.bindPopup(`<strong>${s.name}</strong><br>📞 ${s.phone}`);
      });

      // Attempt geolocation
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude, longitude} = pos.coords;
          map.setView([latitude, longitude], 13);
          userMarker = L.circleMarker([latitude, longitude], {radius:8}).addTo(map);
          userMarker.bindPopup('You are here').openPopup();
        }, err=>{
          console.log('Geo blocked or failed:', err.message);
        }, { enableHighAccuracy:true, timeout:8000 });
      }

      // Nice seller “chips”
      //const chips = document.getElementById('sellerChips');
      //chips.innerHTML = sellers.map(s=>`<div class="seller-pill">📍 ${s.name} · ${s.phone}</div>`).join('');
    }

    /***********************
     * Auth
     ***********************/
    const regEmail = document.getElementById('regEmail');
    const regPhone = document.getElementById('regPhone');
    const regPass  = document.getElementById('regPass');
    const btnCreate = document.getElementById('btnCreate');
    const verifyBox = document.getElementById('verifyBox');
    const verifyCode = document.getElementById('verifyCode');
    const btnVerify = document.getElementById('btnVerify');

    const loginEmail = document.getElementById('loginEmail');
    const loginPass  = document.getElementById('loginPass');
    const btnLogin   = document.getElementById('btnLogin');

    const authCard = document.getElementById('authCard');
    const appCard  = document.getElementById('appCard');
    const welcomeName = document.getElementById('welcomeName');

    btnCreate.addEventListener('click', ()=>{
      const email = regEmail.value.trim().toLowerCase();
      const phone = cleanPhone(regPhone.value.trim());
      const pass  = regPass.value;
      const name  = regName.value;
      if(!name || !email || !phone || !pass) return alert('Please fill all fields');
      if(!/^07\d{8}$/.test(phone) && !/^\+2547\d{8}$/.test(phone)) {
        return alert('Enter a Safaricom number like 07XXXXXXXX');
      }
      const users = store.users;
      if(users.find(u=>u.email===email)) return alert('Email already registered');
      // Create pending user (unverified)
    });

    // Helper: hash password using SHA-256
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    btnCreate.addEventListener('click', async ()=>{
      const email = regEmail.value.trim().toLowerCase();
      const phone = cleanPhone(regPhone.value.trim());
      const pass  = regPass.value;
      const name  = regName.value;

      if(!name || !email || !phone || !pass) return alert('Please fill all fields');

      if(!/^07\d{8}$/.test(phone) && !/^\+2547\d{8}$/.test(phone)) {
        return alert('Enter a Safaricom number like 07XXXXXXXX');
      }

      // Get users from localStorage, or empty array if none
      const users = JSON.parse(localStorage.getItem('users')) || [];

      // Check if email already exists
      if(users.find(u => u.email === email)) {
        return alert('Email already registered');
      }

      // Check if phone already exists
      if(users.find(u => u.phone === phone)) {
        return alert('Phone number already registered');
      }

      // Hash the password before storing
      const hashedPass = await hashPassword(pass);

      // Create new user object with hashed password
      const newUser = { name, email, phone, pass: hashedPass };

      // Add new user to users array
      users.push(newUser);

      // Save updated users list back to localStorage
      localStorage.setItem('users', JSON.stringify(users));

      // Confirmation message
      alert('Account successfully created!');
  
      // Optional: clear form fields
      regName.value = '';
      regEmail.value = '';
      regPhone.value = '';
      regPass.value = '';
    });

    // Same helper from before
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    btnLogin.addEventListener('click', async ()=>{
      const email = loginEmail.value.trim().toLowerCase();
      const pass  = loginPass.value;

      if(!email || !pass) return alert('Please enter email and password');

      // Get users from localStorage
      const users = JSON.parse(localStorage.getItem('users')) || [];

      // Find user by email
      const user = users.find(u => u.email === email);
      if(!user) return alert('No account found with this email');

      // Hash entered password
      const hashedPass = await hashPassword(pass);

      // Compare hashes
      if(user.pass === hashedPass) {
        alert('Login successful!');
        // Optional: mark user as logged in
        localStorage.setItem('currentUser', JSON.stringify(user));
      } else {
        alert('Incorrect password');
      }

      // Clear form fields
      loginEmail.value = '';
      loginPass.value = '';

      onLoggedIn();
    });

    function onLoggedIn(){
      authCard.classList.add('hidden');
      appCard.classList.remove('hidden');
      const s = store.session;
      welcomeName.textContent = s.email;
      document.getElementById('summaryPhone').textContent = s.phone;

      // Populate seller select
      const sel = document.getElementById('sellerSelect');
      sel.innerHTML = sellers.map(s=>`<option value="${s.id}">${s.name} (${s.phone})</option>`).join('');
      updateSummarySeller();
      renderHistory();
    }

    document.getElementById('btnLogout').addEventListener('click', ()=>{
      store.session = null;
      appCard.classList.add('hidden');
      authCard.classList.remove('hidden');
    });

    function cleanPhone(p){ return p.replace(/\s+/g,''); }
    function normalizeTo254(p){
      if(p.startsWith('+254')) return p;
      if(p.startsWith('0')) return '+254'+p.slice(1);
      return p; // naive
    }

    /***********************
     * Tabs
     ***********************/
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const target = t.dataset.tab;
        document.querySelectorAll('#appCard section').forEach(sec=>{
          sec.classList.add('hidden');
        });
        document.getElementById('tab-'+target).classList.remove('hidden');
      });
    });

    /***********************
     * New Order + Payment
     ***********************/
    const qty = document.getElementById('qty');
    const total = document.getElementById('total');
    const notes = document.getElementById('notes');
    const btnPayNow = document.getElementById('btnPayNow');
    const btnPayOnDelivery = document.getElementById('btnPayOnDelivery');
    const sellerSelect = document.getElementById('sellerSelect');
    const summarySeller = document.getElementById('summarySeller');
    const summaryStatus = document.getElementById('summaryStatus');

    qty.addEventListener('input', updateTotals);
    sellerSelect.addEventListener('change', updateSummarySeller);
    function updateTotals(){
      const q = Math.max(0, parseInt(qty.value||'0',10));
      total.value = (q * PRICE_PER_KG).toString();
    }
    function updateSummarySeller(){
      const s = sellers.find(x=>x.id===sellerSelect.value) || sellers[0];
      if(s){ summarySeller.textContent = `${s.name} (${s.phone})`; }
    }
    updateTotals();

    // Modal
    const paymentModal = document.getElementById('paymentModal');
    const stkPhone = document.getElementById('stkPhone');
    const stkAmount = document.getElementById('stkAmount');
    const btnStartStk = document.getElementById('btnStartStk');
    const btnCancelStk = document.getElementById('btnCancelStk');
    const stkStatus = document.getElementById('stkStatus');

    btnPayNow.addEventListener('click', ()=>{
      const session = store.session;
      if(!session) return alert('Please log in');
      const q = parseInt(qty.value||'0',10);
      if(q<=0) return alert('Enter quantity (kg)');
      stkPhone.value = session.phone;
      stkAmount.value = (q * PRICE_PER_KG).toString();
      stkStatus.textContent = '';
      paymentModal.style.display = 'flex';
    });
    btnCancelStk.addEventListener('click', ()=> paymentModal.style.display='none');

    btnStartStk.addEventListener('click', async ()=>{
      const phone = normalizeTo254(cleanPhone(stkPhone.value));
      const amount = parseInt(stkAmount.value,10);
      if(!/^\+2547\d{8}$/.test(phone)) return stkStatus.textContent = 'Enter a valid +2547XXXXXXXX number';
      stkStatus.textContent = 'Requesting STK push…';

      // BACKEND NEEDED: Replace with your M-Pesa STK push endpoint
      // const res = await fetch('/api/mpesa/stkpush', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, amount })});
      // const data = await res.json();
      // For demo, simulate:
      await sleep(1200);
      stkStatus.textContent = 'Prompt sent to your phone. Please enter M-Pesa PIN…';
      await sleep(2000);
      stkStatus.textContent = 'Payment successful ✅';

      // After success -> create order, notify seller
      await finalizeOrder('PAID');
      paymentModal.style.display = 'none';
    });

    btnPayOnDelivery.addEventListener('click', async ()=>{
      const q = parseInt(qty.value||'0',10);
      if(q<=0) return alert('Enter quantity (kg)');
      await finalizeOrder('POD'); // Pay On Delivery
    });

    async function finalizeOrder(paymentMethod){
      const session = store.session;
      const q = parseInt(qty.value,10);
      const amount = q * PRICE_PER_KG;
      const seller = sellers.find(x=>x.id===sellerSelect.value) || sellers[0];

      const order = {
        id: 'ORD-'+Date.now(),
        when: new Date().toISOString(),
        user: session.email,
        phone: session.phone,
        seller: { id:seller.id, name:seller.name, phone:seller.phone },
        qty: q, amount,
        notes: notes.value.trim(),
        method: paymentMethod, // 'PAID' | 'POD'
        status: paymentMethod==='PAID' ? 'Confirmed' : 'Pending'
      };

      // Save locally
      const all = store.orders;
      all.unshift(order);
      store.orders = all;

      // Send to seller phone (backend SMS/WhatsApp/GSM modem)
      try{
        // BACKEND NEEDED: Replace with your seller notification hook
        // await fetch('/api/notify-seller', {
        //   method:'POST', headers:{'Content-Type':'application/json'},
        //   body: JSON.stringify({ to: order.seller.phone, order })
        // });
        console.log('Demo: would notify seller', order);
      }catch(e){
        console.warn('Seller notification failed', e);
      }

      summaryStatus.textContent = paymentMethod==='PAID' ? 'Paid & Sent' : 'POD Sent';
      alert(`Order sent to ${seller.name} (${seller.phone}).\nStatus: ${order.status}\nAmount: KSh ${amount}`);
      renderHistory();

      // Clear draft notes if you want:
      // notes.value = '';
    }

    /***********************
     * History
     ***********************/
    const historyList = document.getElementById('historyList');
    function renderHistory(){
      const orders = store.orders.filter(o=> store.session && o.user===store.session.email );
      if(!orders.length){
        historyList.innerHTML = `<div class="center muted">No orders yet.</div>`;
        return;
      }
      historyList.innerHTML = orders.map(o=>{
        const d = new Date(o.when);
        return `
          <div class="order-item">
            <div><strong>${o.id}</strong> · <span class="muted">${d.toLocaleString()}</span></div>
            <div>Seller: ${o.seller.name} · ${o.seller.phone}</div>
            <div>Qty: <strong>${o.qty} kg</strong> · Total: <strong>KSh ${o.amount}</strong> · Method: <span class="pill">${o.method}</span></div>
            <div class="muted">${o.notes ? 'Notes: '+escapeHtml(o.notes) : ''}</div>
            <div>Status: <span class="tag">${o.status}</span></div>
          </div>
        `;
      }).join('');
    }

    /***********************
     * Helpers
     ***********************/
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])) }

    // Quantity init
    qty.dispatchEvent(new Event('input'));

    // Auto-login if session exists
    window.addEventListener('load', ()=>{
      initMap();
      const s = store.session;
      if(s){
        onLoggedIn();
      }
    });
  </script>
</body>
</html>
