<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Onionn — Lowest bulb onion prices in the market</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>

    #referPopupContent {
    /* your existing styles */
    }

    border: 5px solid red;              /* inner red border */
    box-shadow: 0 0 0 10px white,       /* 10px white gap */
                0 0 0 15px black;       /* outer black border */
    
    /* --- unchanged app styles (kept as before) --- */
    #submitOrderBtn {
      background-color: #27b02e;
      color: white;
    }
    h1, h2, p {
      color: black;
    }
    h1, h2, label {
      font-family: 'Metropolis', sans-serif;
    }
    :root{
      --brand:#27b02e;
      --brand-dark:#0f7c36;
      --ink:#27b02e;
      --muted:#6b7280;
      --bg:#9ec8e8;
      --card:#ffffff;
      --border:#1f2937;
      --accent:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--ink);}
    header{padding:24px 12px 8px;text-align:center;}
    .logo{display:inline-flex;align-items:center;gap:12px;font-weight:800;font-size:clamp(24px,3.5vw,40px);color:var(--brand);font-family: 'Metropolis', sans-serif;}
    .logo .mark{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#8A1422);display:inline-flex;align-items:center;justify-content:center;color:white;font-weight:900;}
    .container{max-width:980px;margin:0 auto;padding:0 12px 60px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.04);margin-top:12px;}
    #map{width:100%;height:340px;border-radius:12px;border:1px solid var(--border);}
    h2{text-align:center;font-size:20px;}
    h1{text-align:center;font-size:15px;}
    label{display:block;margin:12px 0 6px;color:var(--muted);font-size:14px}
    input,select,textarea,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);font-size:16px;}
    textarea{resize:vertical;min-height:80px;}
    .btn{cursor:pointer;background:var(--brand);color:white;font-weight:700;margin-top:12px;border:none;}
    .btn.secondary{background:#111827;}
    .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand);}
    .summary{white-space:pre-wrap;background:#f8fafc;padding:12px;border-radius:10px;border:1px dashed var(--border);font-size:13px;}
    .success{color:var(--brand-dark);font-weight:600;margin-top:8px}

    /* WhatsApp icon button */
    .whatsapp-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #25D366;
      color: white;
      font-size: 28px;
      border-radius: 50%;
      padding: 12px 16px;
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* --- Popup styles (updated with green background, graphics, smaller text, shake, close) --- */
    #referPopup {
      display: none; /* shown on load via JS */
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* Square popup content */
    #referPopupContent {
      width: 320px;
      height: 320px;
      border-radius: 14px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #ffffff;
      box-shadow: 0 12px 40px rgba(2,6,23,0.45);
      cursor: default;
      /* layered green gradients */
      background:
        linear-gradient(180deg, rgba(6,95,70,0.95), rgba(34,197,94,0.95)),
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.06), transparent 15%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,0.03), transparent 12%);
      -webkit-backdrop-filter: blur(0px);
      backdrop-filter: blur(0px);
    }

    /* subtle money-splash SVG overlay for 'beautiful graphics' - embedded as data URI */
    #referPopupContent::before{
      content: "";
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 800'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%23ffffff' stop-opacity='0.08'/><stop offset='1' stop-color='%23ffffff' stop-opacity='0.02'/></linearGradient></defs><g fill='none' stroke='url(%23g)' stroke-width='2' opacity='0.6'><path d='M120 580c60-40 120-90 220-60 100 30 180-20 260-30 80-10 140 60 180 80'/><path d='M80 200c60 40 110 110 210 120 100 10 170-50 260-40 90 10 140 80 180 110'/><path d='M40 420c50-60 130-90 220-70 90 20 160 0 250-30 90-30 170 20 210 40' /></g><g fill='%23fff' fill-opacity='0.07'><circle cx='50' cy='50' r='20'/><circle cx='760' cy='100' r='24'/><circle cx='720' cy='700' r='28'/></g></svg>");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 140% 140%;
      pointer-events: none;
      mix-blend-mode: overlay;
      transform: translateZ(0);
    }

    /* Title text - reduced by 20% vs 22px -> 17.6px (we use 17.6px) */
    #referPopupContent .popup-text{
      position: relative;
      z-index: 2;
      font-family: 'Metropolis', sans-serif;
      font-weight: 800;
      font-size: 17.6px;
      line-height: 1.2;
      padding: 8px 18px;
      letter-spacing: 0.2px;
      -webkit-font-smoothing: antialiased;
      animation: subtle-shake 1.2s infinite ease-in-out;
      transform-origin: 50% 50%;
    }

    /* Slight, tasteful shake (small amplitude) */
    @keyframes subtle-shake {
      0% { transform: translateX(0) rotate(0.0deg); }
      15% { transform: translateX(-2px) rotate(-0.2deg); }
      30% { transform: translateX(2px) rotate(0.2deg); }
      45% { transform: translateX(-1.4px) rotate(-0.1deg); }
      60% { transform: translateX(1.4px) rotate(0.1deg); }
      75% { transform: translateX(-0.8px) rotate(-0.05deg); }
      100% { transform: translateX(0) rotate(0); }
    }

    /* Close button */
    #referPopupContent .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 3;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.95);
      color: #27b02e;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(2,6,23,0.2);
    }
    #referPopupContent .close-btn:active { transform: scale(0.98); }

    /* Make sure popup text is readable on small screens */
    @media (max-width:420px){
      #referPopupContent { width: 86vw; height: 86vw; }
      #referPopupContent .popup-text { font-size: 16px; padding: 10px; }
    }
  </style>
</head>
<body>
  <!-- Popup (square) -->
  <div id="referPopup" aria-hidden="true">
    <div id="referPopupContent" role="dialog" aria-label="Referral offer">
      <button class="close-btn" id="closePopup" aria-label="Close popup">&times;</button>
      <div class="popup-text">Earn 2000/= every time you refer a farmer anywhere in Kenya and they become a farmer partner. Click "become a partner" button below, fill it out together with the farmer, then send email. Our seedlings are free!</div>
    </div>
  </div>

  <header>
    <div class="logo"><div class="mark">🧅</div>Onionn</div>
  </header>
  <h2>📱Order onions online 🚚 Free same day delivery 💵 Save up to 50%! 📱Payment on delivery</h2>
  <h2>📱Our current price: 50 Kes per kg 💵 Become a partner 💵 Earn points</h2>
  <h1>🧅Service available in Nairobi, Kitengela, Malindi, Kilifi, Mombasa</h1>
  <h1>🧅Current stock: 🧅Nairobi:Sold out 🧅Kitengela: Available 🧅Malindi: Sold out 🧅Kilifi: Sold out 🧅Mombasa: Sold out</h1>

  <main class="container">
    <!-- Map -->
    <div class="card">
      <div id="map"></div>
    </div>

    <!-- Order Section -->
    <div id="orderArea" class="card">
      <div class="row">
        <div>
          <h2>Order onions (50 Ksh / Kg)</h2>

          <!-- Customer Details -->
          <label for="custName">Customer Name</label>
          <input id="custName" type="text" placeholder="Full Name"/>

          <label for="referredBy">Referred by (optional)</label>
          <input id="referredBy" style= "font-family: 'metropolis', sans serif;" type="text" placeholder="Name and number"/>

          <label for="custPhone">Phone Number</label>
          <input id="custPhone" type="tel" placeholder="07xx xxx xxx"/>

          <label for="custEmail">Email</label>
          <input id="custEmail" type="email" placeholder="example@email.com"/>

          <!-- Order Details -->
          <label for="qty">Quantity (Kg)</label>
          <input id="qty" type="number" min="1" value="1" />

          <label>Delivery location</label>
          <div style="display:flex;gap:8px;">
            <button id="useGeoBtn" class="btn">Detect my location</button>
            <button id="manualBtn" class="btn">Enter manually</button>
          </div>
          <div id="manualWrap" class="hidden">
            <label for="manualLocation">Manual delivery location</label>
            <input id="manualLocation" placeholder="Address or description"/>
          </div>

          <!-- Preferred Time -->
          <label for="deliveryTime">Preferred Delivery Time</label>
          <input id="deliveryTime" type="text" placeholder="e.g. 2 PM - 4 PM"/>

          <!-- Special Notes -->
          <label for="specialNotes">Special Delivery Notes / Instructions</label>
          <textarea id="specialNotes" placeholder="Any instructions for delivery?"></textarea>

          <!-- Payment -->
          <label>Payment method (payment on delivery available now)</label>
          <select id="paymentMode">
          
            <option value="pod">Payment on delivery</option>
          </select>

          <div id="mpesaOptions" class="hidden">
            <label for="mpesaAccount">Account / Business Name (optional)</label>
            <input id="mpesaAccount"/>
          </div>

          <!-- Copy to Email -->
          <label for="sendCopy">Send Copy of Order to Customer Email</label>
          <select id="sendCopy">
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>

          <div style="display:flex;gap:8px;">
            <button id="previewBtn" class="btn">Preview Order</button>
            <button id="partnerBtn" class="btn">Become a Partner</button>
          </div>
        </div>
        <div>
          <h2>Order summary</h2>
          <div id="summaryBox" class="summary" style= "color:black;" >No summary yet.</div>
          <button id="submitOrderBtn" class="btn secondary" style="margin-top:12px;">Submit Order</button>
        </div>
      </div>
    </div>

    <!-- User Data Safety (bottom of page) -->
    <div class="card center">
      <h2>User Data Safety</h2>
      <p class="muted"style="text-align:center; font-family:'Metropolis', sans-serif;">Click below to clear your data.</p>
      <button id="logoutDataBtn" class="btn">Clear User Data</button>
      <div id="message" class="success hidden"></div>
    </div>
  </main>

  <!-- WhatsApp Floating Button -->
  <a href="https://wa.me/254708253594" target="_blank" class="whatsapp-btn">💬</a>

  <!-- Partner modal -->
  <div id="partnerBackdrop" class="modal-backdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;">
    <div class="modal card" style="max-width:500px;">
      <h2>Become a farmer or Seller Partner (free seedlings)</h2>
      <label for="partner_name">Your full names(farmer)</label>
      <input id="partner_name" type="text" />
      <label for="referred_by">Referred by- full name and phone (optional)</label>
      <input id="referred_by" type="text" />
      <label for="partner_email">Your email (farmer)</label>
      <input id="partner_email" type="email" />
      <label for="partner_phone">Your phone (farmer)</label>
      <input id="partner_phone" type="tel" />
      <label for="partner_location">Farm Location</label>
      <input id="partner_location" />
      <label for="farm_size">Farm size (acres)</label>
      <input id="farm_size" />
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="partnerSubmitBtn" class="btn">Send Inquiry</button>
        <button id="partnerCancelBtn" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const PRICE_PER_KG = 50;
    const SELLER_PHONE = '+254708253594';
    const SELLER_EMAIL = 'wambuguhkw@gmail.com';
    const VENDOR_COUNT = 6;

    // Show popup on load
    window.addEventListener("load", () => {
      const popup = document.getElementById("referPopup");
      if (popup) popup.style.display = "flex";
      initMap();
    });

    // Close popup
    const closeBtn = document.getElementById("closePopup");
    if (closeBtn) {
      closeBtn.addEventListener("click", () => {
        const popup = document.getElementById("referPopup");
        if (popup) popup.style.display = "none";
      });
    }

    // Clear user data
    document.getElementById("logoutDataBtn").addEventListener("click", () => {
      localStorage.clear();
      document.getElementById("message").textContent = "✅ Data cleared.";
      document.getElementById("message").classList.remove("hidden");
    });

    // Map + vendors
    let userGeo=null, map, userMarker, vendorLayer;
    function initMap(){
      map=L.map("map").setView([-1.286389,36.817223],13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
      vendorLayer=L.layerGroup().addTo(map);
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          userGeo={lat:pos.coords.latitude,lng:pos.coords.longitude};
          map.setView([userGeo.lat,userGeo.lng],13);
          userMarker=L.circleMarker([userGeo.lat,userGeo.lng],{radius:8,color:"#0f7c36",fill:"#0f7c36"}).addTo(map).bindPopup("You are here");
          placeVendorsNearUser();
        },()=>placeVendorsNearUser());
      } else placeVendorsNearUser();
    }
    function placeVendorsNearUser(){
      vendorLayer.clearLayers();
      const center=userGeo?[userGeo.lat,userGeo.lng]:[-1.286389,36.817223];
      for(let i=0;i<VENDOR_COUNT;i++){
        const lat=center[0]+(Math.random()*0.03-0.015);
        const lng=center[1]+(Math.random()*0.03-0.015);
        const dist=distanceBetween(center[0],center[1],lat,lng);
        const eta=(dist/30)*60;
        L.marker([lat,lng]).addTo(vendorLayer).bindPopup(`Vendor ${i+1}<br>Est. ${Math.round(eta)} min<br>${dist.toFixed(2)} km`);
      }
    }
    function distanceBetween(a,b,c,d){const R=6371;const dLat=(c-a)*Math.PI/180;const dLon=(d-b)*Math.PI/180;const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}

    // Delivery + payment logic
    const manualWrap=document.getElementById("manualWrap");
    const manualLocation=document.getElementById("manualLocation");
    let manualLoc="";
    document.getElementById("useGeoBtn").addEventListener("click",()=>{if(userGeo){manualLoc="";manualWrap.classList.add("hidden");alert("Delivery set to geolocation");}});
    document.getElementById("manualBtn").addEventListener("click",()=>manualWrap.classList.remove("hidden"));
    manualLocation.addEventListener("input",()=>manualLoc=manualLocation.value.trim());

    const paymentMode=document.getElementById("paymentMode");
    const mpesaOptions=document.getElementById("mpesaOptions");
    paymentMode.addEventListener("change",()=>mpesaOptions.classList.toggle("hidden",paymentMode.value!=="mpesa"));

    // Build summary
    function buildSummary(){
      const qty=Number(document.getElementById("qty").value)||0;
      const total=qty*PRICE_PER_KG;
      const now=new Date().toLocaleString();
      const name=document.getElementById("custName").value.trim();
      const referredBy=document.getElementById("referredBy").value.trim();
      const phone=document.getElementById("custPhone").value.trim();
      const email=document.getElementById("custEmail").value.trim();
      const deliveryTime=document.getElementById("deliveryTime").value.trim();
      const notes=document.getElementById("specialNotes").value.trim();
      const sendCopy=document.getElementById("sendCopy").value==="yes"?"Yes":"No";
      const payment=paymentMode.value==="mpesa"?"M-Pesa":"Payment on Delivery";
      const account=document.getElementById("mpesaAccount").value.trim();
      let delivery=manualLoc|| (userGeo?`${userGeo.lat.toFixed(6)},${userGeo.lng.toFixed(6)}`:"Not set");

      return `Order time: ${now}
Customer: ${name}
Referred by (optional): ${referredBy}
Phone: ${phone}
Email: ${email}
Quantity: ${qty} Kg
Total: ${total} Ksh
Preferred delivery time: ${deliveryTime}
Special delivery Notes: ${notes}
Delivery location: ${delivery}
Payment method: ${payment}
Account: ${account}
Send Copy to Customer Email: ${sendCopy}`;
    }
    document.getElementById("previewBtn").addEventListener("click",()=>{document.getElementById("summaryBox").textContent=buildSummary();});
    document.getElementById("submitOrderBtn").addEventListener("click",()=>sendOrderViaExternalLink(buildSummary()));

    function sendOrderViaExternalLink(summary){
      if(/Mobi|Android|iPhone/i.test(navigator.userAgent)){window.location.href=`sms:${SELLER_PHONE}?body=${encodeURIComponent(summary)}`;}
      else{window.location.href=`mailto:${SELLER_EMAIL}?subject=Onionn Order&body=${encodeURIComponent(summary)}`;}
    }

    // Partner modal
    const partnerBackdrop=document.getElementById("partnerBackdrop");
    const partnerBtnElem = document.getElementById("partnerBtn");
    const partnerCancelBtn = document.getElementById("partnerCancelBtn");
    const partnerSubmitBtn = document.getElementById("partnerSubmitBtn");

    // NEW: geolocation input element (added to the form above)
    // We'll reference it here:
    // Note: element exists in DOM as <input id="partner_geolocation" />
    // If it doesn't exist for any reason, the code will fail gracefully.
    partnerBtnElem.addEventListener("click",()=>{
      partnerBackdrop.style.display="flex";

      // Try to auto-detect geolocation and populate the new partner_geolocation input.
      const geoInput = document.getElementById("partner_geolocation");
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          if (geoInput) geoInput.value = `${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}`;
        }, err=>{
          if (geoInput) geoInput.value = "";
          alert("⚠️ Could not detect location. Geolocation is required to become a partner. Please allow location access and click 'Become a Partner' again, or reload the page and allow location.");
        }, {enableHighAccuracy:true, timeout:10000});
      } else {
        if (geoInput) geoInput.value = "";
        alert("⚠️ Geolocation not supported by your browser. The partner form requires geolocation.");
      }
    });

    partnerCancelBtn.addEventListener("click",()=>{partnerBackdrop.style.display="none";});
    partnerSubmitBtn.addEventListener("click",()=>{
      const pName = document.getElementById("partner_name").value.trim();
      const pReferred = document.getElementById("referred_by").value.trim();
      const pEmail = document.getElementById("partner_email").value.trim();
      const pPhone = document.getElementById("partner_phone").value.trim();
      const pLocation = document.getElementById("partner_location").value.trim();
      const pFarmSize = document.getElementById("farm_size").value.trim();
      const pGeo = (document.getElementById("partner_geolocation") && document.getElementById("partner_geolocation").value) ? document.getElementById("partner_geolocation").value.trim() : "";

      // Require both geolocation and farm location (both mandatory and separate)
      if(!pGeo){
        alert("❌ Geolocation is required. Please allow location access when prompted and open the Become a Partner form again.");
        return;
      }
      if(!pLocation){
        alert("❌ Farm Location (manual) is required. Please enter your farm location.");
        return;
      }

      // Build partner inquiry summary including the geolocation and farm location so it can be sent via email
      const partnerSummary = `Partner inquiry:
Name: ${pName}
Referred by: ${pReferred}
Email: ${pEmail}
Phone: ${pPhone}
Geolocation: ${pGeo}
Farm Location: ${pLocation}
Farm size (acres): ${pFarmSize}`;

      // Send partner inquiry via mailto with the summary in the email body
      window.location.href = `mailto:${SELLER_EMAIL}?subject=${encodeURIComponent("Partner inquiry")}&body=${encodeURIComponent(partnerSummary)}`;

      alert("Partner inquiry sent.");
      partnerBackdrop.style.display="none";
    });
  </script>
</body>
</html>
